## 3.1 第1次迭代

### 3.1.1 分解系统组件

选择**文件管理模块**继续分解。

### 3.1.2 确定架构驱动因素

| #   | 架构驱动因素                                    | 重要性 | 难易度 |
| --- | ----------------------------------------------- | ------ | ------ |
| 1   | 功能需求：共享文件                              | 高     | 高     |
| 2   | 场景12：文件上传和下载                          | 高     | 高     |
| 3   | 场景6：断线重连                                 | 高     | 中     |
| 4   | 设计约束1：用户的数据不得被泄露和非法修改       | 高     | 中     |
| 5   | 场景5：用户企图下载未选课的课程文件             | 高     | 低     |
| 6   | 场景2：用户正常操作                             | 中     | 低     |
| 7   | 场景3：由于各种原因导致的系统出错               | 中     | 低     |
| 8   | 场景10：用户请求服务                            | 低     | 中     |
| 9   | 设计约束2：系统应该能在市面上绝大多数设备上运行 | 中     | 低     |


### 3.1.3 选择满足架构驱动因素的架构模式

#### 3.1.3.1 设计关注点

| 质量属性 | 设计关注点             | 子关注点                     |
| -------- | ---------------------- | ---------------------------- |
| 性能     | 良好的上传下载体验     | 良好的上传下载速度           |
|          |                        | 快速的响应速度               |
|          |                        | 可支持多个资源同时上传和下载 |
| 可用性   | 断线重连               | 检测网络中断                 |
|          |                        | 上传下载中断可以恢复进度     |
|          | 高可用时间             | 系统应达到99.9%可用时间      |
| 安全性   | 数据不得泄露和非法修改 | 防止数据非法访问和修改       |
|          | 用户权限设定           | 不得下载没有权限的文件       |
|          |                        | 学生用户不得上传文件         |

#### 3.1.3.2 候选模式

**良好的上传下载速度**

| #   | 模式名称                                                 | 开发难度 | 速度提升效果 | 数据安全性 | 硬件需求 | 成本 |
| --- | -------------------------------------------------------- | -------- | ------------ | ---------- | -------- | ---- |
| 1   | 多线程上传和下载                                         | 中       | 中           | 高         | 低       | 低   |
| 2   | 使用UDP协议传输数据                                      | 中       | 中           | 中         | 低       | 低   |
| 3   | 使用多个节点保存数据                                     | 高       | 高           | 中         | 中       | 低   |
| 4   | 使用高带宽连接方式（例如Wi-Fi Direct协议而不是蓝牙协议） | 低       | 高           | 高         | 高       | 高   |
| 5   | 引入外部内容分发网络（CDN）                              | 低       | 高           | 中         | 中       | 高   |
| 6   | 提高硬件性能                                             | 低       | 中           | 高         | 高       | 高   |

选择模式：**多线程上传和下载**、**使用UDP协议**

选择理由：系统对数据安全性要求很高，所以不能冒险将数据保存到网络上和其他节点上。同时，存储到CDN需要付出巨大的网络成本。由于系统需要在尽可能多的设备上运行，且一些设备可能并不支持Wi-Fi Direct协议，所以不能将系统的性能依赖于连接方式和硬件的速度。UDP和多线程是目前常用的网络加速方法，开发资料丰富，效果良好，且无数据泄露风险，故选择。

**快速的响应速度**

| #   | 模式名称             | 开发难度 | 速度提升效果 | 数据及时性 |
| --- | -------------------- | -------- | ------------ | ---------- |
| 1   | 优先处理资源列表请求 | 中       | 高           | 高         |
| 2   | 本地缓存资源列表     | 中       | 高           | 中         |

选择模式：**优先处理资源列表请求**、**本地缓存资源列表**

选择理由：两种方法均能有效提高获得响应速度，故均选用。本地缓存的资源过期问题可以通过用户手动刷新解决。

**可支持多个资源同时上传和下载**

| #   | 模式名称                    | 成本 | 效果 | 开发难度 |
| --- | --------------------------- | ---- | ---- | -------- |
| 1   | 引入外部内容分发网络（CDN） | 高   | 高   | 低       |
| 2   | 多线程                      | 低   | 中   | 高       |

选择模式：**多线程**

选择理由：和之前一样，引入CDN会增加巨大的网络成本。多线程能充分利用系统资源，在不付出额外成本的情况下提高能同时上传和下载的资源数。

**检测网络中断**

| #   | 模式名称                     | 性能影响 | 响应速度       |
| --- | ---------------------------- | -------- | -------------- |
| 1   | 心跳                         | 低       | 中             |
| 2   | Ping-echo                    | 中       | 中             |
| 3   | 一段时间内没有速度即认为中断 | 低       | 依赖于时间间隔 |

选择模式：**心跳**

选择理由：一段时间内没有速度认为中断容易在网络负载大的时候造成假阳性的问题。心跳比ping-echo不需要额外硬件资源和设置，并能达到可以接受的响应速度。

**上传下载中断可以恢复进度**

| #   | 模式名称                   | 成本 | 效果 | 开发难度 | 系统硬件和网络资源消耗 |
| --- | -------------------------- | ---- | ---- | -------- | ---------------------- |
| 1   | 首先将文件保存到外部服务器 | 高   | 高   | 低       | 低                     |
| 2   | 使用临时文件保存进度       | 低   | 高   | 中       | 中                     |
| 3   | 减少每个包的大小           | 低   | 高   | 高       | 中                     |

选择模式：**使用临时文件保存进度**、**减少每个包的大小**

选择理由：将文件都首先保存到外部服务器会增加成本，故不选用。减少包的大小和使用临时文件能够让网络中断时损失的进度降低。

**系统应达到99.9%可用时间**

| #   | 模式名称                             | 成本 | 可用时间 | 文件大小限制 |
| --- | ------------------------------------ | ---- | -------- | ------------ |
| 1   | 将部分常用文件存储于外部服务器       | 高   | 高       | 低           |
| 2   | 在网络可用时在后台将文件保存到设备上 | 低   | 中       | 高           |

选择模式：**在网络可用时在后台将文件保存到设备上**

选择理由：将文件保存到外部服务器可能会造成数据安全性和网络流量问题。可以让用户自己选择是否在网络可用时将所有文件都缓存到本地。

**防止数据非法访问和修改**

| #   | 模式名称               | 成本 | 对性能的影响 | 数据泄露影响 | 用户体验影响 | 开发难度 |
| --- | ---------------------- | ---- | ------------ | ------------ | ------------ | -------- |
| 1   | 加密文件               | 低   | 高           | 低           | 中           | 低       |
| 2   | 定时更改文件接口的地址 | 中   | 高           | 高           | 低           | 高       |
| 3   | 禁止可疑网络请求       | 低   | 低           | 高           | 中           | 低       |
| 4   | 使用中心化数据服务器   | 高   | 低           | 高           | 中           | 低       |
| 5   | 保存多份文件副本       | 高   | 高           | 高           | 中           | 中       |

选择模式：**加密文件**、**禁止可疑网络请求**

选择理由：对每个文件都进行加密会造成性能灾难，但是可以采取加密部分非常重要的文件的策略。禁止可疑网络请求能够过滤一些非法请求，提高系统安全性。使用中心化数据服务器会提高成本。定时更改接口地址很可能会带来地址的同步问题。保存多份文件副本会增加资源消耗。

**不得下载没有权限的文件**

| #   | 模式名称           | 成本 | 性能开销 | 开发难度 | 安全性 |
| --- | ------------------ | ---- | -------- | -------- | ------ |
| 1   | 对每个请求进行鉴权 | 低   | 中       | 低       | 高     |
| 2   | 维护可访问文件列表 | 中   | 低       | 高       | 中     |

选择模式：**对每个请求进行鉴权**

选择理由：维护可访问文件列表需要保证文件列表实时更新，开发难度极大，且一旦同步出现问题会极大降低用户体验和数据安全问题，故不选用。

**学生用户不得上传文件**

| #   | 模式名称           | 成本 | 性能开销 | 开发难度 | 安全性 |
| --- | ------------------ | ---- | -------- | -------- | ------ |
| 1   | 对每个请求进行鉴权 | 低   | 中       | 低       | 高     |
| 2   | 维护教师用户列表   | 中   | 低       | 中       | 中     |

选择模式：**对每个请求进行鉴权**

选择理由：通过对每个请求可以保证安全性和降低开发难度。

### 3.1.4 候选模式与对应ASR

| #   | 模式类型                     | 选择的模式                             | 架构驱动                             |
| --- | ---------------------------- | -------------------------------------- | ------------------------------------ |
| 1   | 良好的上传下载速度           | 多线程上传和下载、使用UDP协议          | 场景12、设计约束1、设计约束2         |
| 2   | 快速的响应速度               | 优先处理资源列表请求、本地缓存资源列表 | 场景2、设计约束1、设计约束2          |
| 3   | 可支持多个资源同时上传和下载 | 使用软件实现负载均衡                   | 场景12、场景2、设计约束1、设计约束2  |
| 4   | 检测网络中断                 | 心跳                                   | 场景6、场景2、设计约束2              |
| 5   | 上传下载中断可以恢复进度     | 使用临时文件保存进度、减少每个包的大小 | 场景12、场景6、场景3、设计约束1      |
| 6   | 系统应达到99.9%可用时间      | 在网络可用时在后台将文件保存到设备上   | 设计约束1、场景2、场景10             |
| 7   | 防止数据非法访问和修改       | 加密文件、禁止可疑网络请求             | 设计约束1                            |
| 8   | 不得下载没有权限的文件       | 对每个请求进行鉴权                     | 场景5、设计约束1、功能需求：共享文件 |
| 9   | 学生用户不得上传文件         | 对每个请求进行鉴权                     | 功能需求：共享文件                   |

### 3.1.5 架构视图

图片


## 3.2 第2次迭代

### 3.2.1 分解系统组件

选择**权限管理模块**继续分解。

### 3.2.2 确定架构驱动因素

| #   | 架构驱动因素                                    | 重要性 | 难易度 |
| --- | ----------------------------------------------- | ------ | ------ |
| 1   | 设计约束1：用户的数据不得被泄露和非法修改       | 高     | 高     |
| 2   | 场景7：学生数据防止被攻击和篡改                 | 高     | 高     |
| 4   | 场景10：用户请求服务                            | 中     | 高     |
| 5   | 场景2：用户正常操作                             | 中     | 中     |
| 6   | 设计约束2：系统应该能在市面上绝大多数设备上运行 | 中     | 中     |

### 3.2.3 选择满足架构驱动因素的架构模式

#### 3.2.3.1 设计关注点

| 质量属性 | 设计关注点   | 子关注点         |
| -------- | ------------ | ---------------- |
| 安全性   | 数据安全     | 防止非法访问     |
|          |              | 防止非法数据     |
| 可用性   | 高可用时间   | 从攻击中恢复     |
| 性能     | 权限检查速度 | 提高权限检查速度 |

### 3.2.3.2 候选模式

**防止非法访问**

| #   | 模式名称                     | 开发难度 | 性能影响 | 安全性 |
| --- | ---------------------------- | -------- | -------- | ------ |
| 1   | 对每个请求单独鉴权           | 中       | 中       | 高     |
| 2   | 对每个请求维护可访问资源列表 | 高       | 低       | 高     |
| 3   | 维持可信地址列表             | 低       | 低       | 低     |
| 4   | 维持黑名单                   | 低       | 低       | 低     |

选择模式：**对每个请求单独鉴权**

选择理由：对每个请求都进行鉴权操作能够保证安全性。

**防止非法数据**

| #   | 模式名称     | 开发难度 | 性能影响 | 安全性 |
| --- | ------------ | -------- | -------- | ------ |
| 1   | 输入数据检验 | 中       | 中       | 高     |

选择模式：**输入数据检验**

选择理由：在提交给后续服务之前检验数据能够确保数据的合法性。

**从攻击中恢复**

| #   | 模式名称     | 开发难度 | 恢复速度 | 用户体验     |
| --- | ------------ | -------- | -------- | ------------ |
| 1   | 黑名单       | 低       | 高       | 对用户透明   |
| 2   | 重新建立网络 | 低       | 中       | 需要用户操作 |
| 3   | 冗余         | 高       | 高       | 对用户透明   |

选择模式：**黑名单**、**重新建立网络**

选择理由：由于节点硬件规模限制，无法采用冗余配置鉴权模块的方式加快恢复速度。采用黑名单可以快速屏蔽小闺蜜的攻击源，恢复系统运行；若攻击规模大，可采用重新建立网络（自动或者手动）的方式恢复系统功能。

**提高权限检查速度**

| #   | 模式名称     | 开发难度 | 性能         |
| --- | ------------ | -------- |
| 1   | 请求队列     | 中       | 中           |
| 2   | 多线程并行   | 中       | 高           |
| 3   | 提高硬件性能 | 低       | 依赖硬件性能 |

选择模式：**请求队列**、**多线程并行**

选择理由：由于需要在尽可能多的硬件上运行，所以不能把系统性能的提高依赖于硬件性能的提高。多线程能够提高权限检查的速度；使用请求队列能够平滑系统性能，提高效率。

### 3.2.4 候选模式与对应ASR

| #   | 模式类型         | 选择的模式           | 架构驱动                 |
| --- | ---------------- | -------------------- | ------------------------ |
| 1   | 防止非法访问     | 对每个请求单独鉴权   | 设计约束1，场景7         |
| 2   | 防止非法数据     | 输入数据检验         | 设计约束1，场景7         |
| 3   | 从攻击中恢复     | 黑名单、重新建立网络 | 场景2，场景10，设计约束2 |
| 4   | 提高权限检查速度 | 请求队列、多线程并行 | 场景2，场景10，设计约束2 |

### 3.2.5 架构视图

图片

## 3.3 第3次迭代

### 3.3.1 分解系统组件

选择**推送模块**继续分解。

### 3.3.2 确定架构驱动因素

| #   | 架构驱动因素                                | 重要性 | 难易度 |
| --- | ------------------------------------------- | ------ | ------ |
| 1   | 场景4：推送信息需要快速有效到达用户         | 高     | 高     |
| 2   | 场景2：用户正常操作                         | 中     | 中     |
| 4   | 设计约束1：用户的数据不得被泄露和非法修改 | 中     | 中     |

### 3.1.3 选择满足架构驱动因素的架构模式

#### 3.1.3.1 设计关注点

| 质量属性 | 设计关注点           | 子关注点                   |
| -------- | -------------------- | -------------------------- |
| 性能     | 推送信息快速到达用户 | 快速到达在线用户           |
|          |                      | 离线用户上线时快速获得推送 |
| 安全性 | 用户数据私密性 | 不能获得其他用户的推送 | 