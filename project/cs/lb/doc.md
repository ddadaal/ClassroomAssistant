## 4.1 第1次迭代

### 4.1.1 分解系统组件

选择**考试模块**继续分解。

### 4.1.2 确定架构驱动因素（重要性、难易度从高到低）

| #    | 架构驱动因素 | 重要性 | 难易度 |
| ---- | :----------- | ------ | ------ |
|1|场景1：大量用户短时间内进行数据量交换较小的操作|中|中|
|2     |场景6：断线重连|高|高|
|3|场景7：学生数据防止被攻击和篡改|高|高|


### 4.1.3 选择满足架构驱动因素的架构模式

#### 4.1.3.1 设计关注点

| 质量属性 | 设计关注点 | 子关注点     |
| -------- | ---------- | ------------ |
| 可用性   | 故障检测   | 快速反应     |
| 可用性   | 故障恢复   | 数据完整性   |
| 安全性   | 高并发     | 密集网络请求 |

#### 4.1.3.2 候选模式

**快速反应**

| #    | 模式名称 | 反应时间 | 准确率 |
| ---- | -------- | -------- | ------ |
|1|异常处理|<0.1秒|可能会误判|
|2|出错重试|<2秒|误判可能性较低|

选择模式：模式2

理由：在通过网络传输数据时，一出现异常就启动断线重连机制，这样做虽然反应快，但可能会把瞬时的网络波动误判成断线；出错重试机制虽然会花费更多时间，但并没有超出要求规定的5秒，且准确率更高，故选择之。

**数据完整性**

|#|模式|存储负载|实现难度|
|---|---|-|-|
|1|检查点|1秒每15秒|低|
|2|检查点+变化日志|1秒每半分钟+每秒2条消息|中|
|3|检查点+捆绑日志|1秒每半分钟+每x秒1条消息|中|
|4|检查点+同步备份|1秒每半分钟+每x秒1条消息|高|

选择模式：模式1

理由：虽然检查点不能完全恢复现场数据，但是场景7并没有要求要完全恢复现场信息，因此实现最简单的检查点完全够用。除此之外，进一步缩短检查点的周期，可以有效提高数据恢复程度。

**密集网络请求**

|#|模式|实现难度|并发性能|
|-|-|-|-|
|1|同步请求|低|<60（取决于硬件和容器）|
|2|集群+负载均衡|高|>10000（取决于硬件和容器）|
|3|消息队列|中|>150（取决于硬件和容器）|

选择模式：模式3

理由：使用同步的方式处理请求将不能满足场景1要求的5s内处理300人的请求；集群+负载均衡的并发性能最好，但是实现难度较大，不经济；使用消息队列缓存用户请求，实现难度中等，并发能力也足以满足要求。
### 4.1.4 候选模式与对应ASR

| #    | 模式类型 | 选择的模式 | 架构驱动 |
| ---- | -------- | ---------- | -------- |
|1|快速反应|出错重试|场景6：断线重连|
|2|数据完整性|检查点|场景6：断线重连|
|3|密集网络请求|消息队列|场景1：大量用户短时间内进行数据量交换较小的操作|


### 4.1.5 架构视图

图片



## 4.2 第二次迭代

### 4.2.1 分解系统组件

本迭代分解客户端节点的下载模块。

### 4.2.2 确定架构驱动因素（重要性、难易度从高到低）

| #    | 架构驱动因素                                     | 重要性 | 难易度 |
| ---- | ------------------------------------------------ | ------ | ------ |
| 1    | 场景5：用户企图下载未选课的课程文件             | 高       |  中      |
| 2    | 场景6：断线重连                                 | 高     | 低       |
| 3	| 场景10：用户请求服务 | 中 | 中 |
| 4 | 场景11：用户请求其他用户的信息 | 中 | 中 |
| 5    | 场景12：文件上传和下载                           | 高     | 高     |

### 4.2.3 选择满足架构驱动因素的架构模式

#### 4.2.3.1 设计关注点

| 质量属性 | 设计关注点       | 子关注点         |
| -------- | ---------------- | ---------------- |
| 安全性   | 资源采集         |  资源压缩编码                |
| 性能     | 资源数据传输     | 资源数据传输协议<br>资源传输效率  |
| 可靠性   | 资源下载中断恢复 | 中断处理和恢复   |

#### 4.2.3.2 候选模式

**资源压缩编码**

| #    | 模式名称 | 压缩率 | 容错能力 | CPU能力要求 | 压缩时间 |
| ---- | -------- | ------ | -------- | ----------- | -------- |
| 1    | RAR压缩  | 高     | 高       | 高          | 中       |
| 2    | ZIP压缩  | 中     | 低       | 高          | 高       |

选择模式：RAR压缩 

选择理由：ZIP占存过大，并且只有英文版，RAR具有官方简体中文且安装包较小，同时RAR压缩率高容错能力高，相比ZIP能支持更多的流行压缩格式。最为关键的是在传输超大型文件过程中RAR支持分卷压缩，降低了上传压力。

**资源数据传输协议**

| #    | 模式名称 | 性能 | 安全性 | 可伸缩性 | 可用性 |
| ---- | -------- | ---- | ------ | -------- | ------ |
| 1    | TCP协议  | 弱   | 强     | 弱       | 强     |
| 2    | UDP协议  | 强   | 弱     | 强       | 弱     |

选择模式：TCP协议 

选择理由：UDP协议是无连接的，它本身没有数据校验机制，不会进行数据的校准和分组确认。而TCP是面向连接的可靠协议，如果发现分组有丢失现象，会请求进行重传。对于资源下载，数据的安全性和可用性非常重要，传送的文件出现问题需要重新下载，反而增加下载时间。所以选择TCP协议进行下载。

**资源传输效率**

| #    | 模式名称       | 性能 | 可伸缩性 | 可用性 |
| ---- | -------------- | ---- | -------- | ------ |
| 1    | 使用镜像服务器 | 高   | 高       | 高     |
| 2    | 离线下载       | 中   | 高       | 高     |
| 3    | 提升服务器带宽 | 高   | 中       | 中     |
| 4    | 限制客户端码率 | 中   | 中       | 中     |

选择模式：镜像服务器加速和离线下载

选择理由： 数据传输效率主要考虑传输速率和传输可用性。传输效率主要由服务器总带宽决定，单一提升某一服务器的带宽的确可以提高传输效事，但使用镜像服务器不仅可以提升总带宽，而且有更高的可用性和容错性。单一服务器的连接并发数是固定的，可容纳用户也有数量上的限制，而使用镜像服务器可以容纳更多的用户，并且可以通过镜像服务器的缓存提高性能。如果某台服务器发生故障，单一服务器就再也不能提供服务，而分布式服务器仍可对用户提供资源而限制客户端的码率并不是长久的方案，首先不满足易用性。所以首选方案是使用镜像服务器,当然也可以根据需求提升镜像服务器的带宽。而离线下载则可以帮助冷门资源的下载，提高性能和可用性，且提高安全性，又不与镜像服务器冲突，所以也会同时使用。

**中断处理和恢复**

| #    | 模式名称                             | 性能 | 易用性 | 安全性 |
| ---- | ------------------------------------ | ---- | ------ | ------ |
| 1    | 保存本地备份，可在重新下载时导入恢复 | 高   | 中     | 中     |
| 2    | 删除本地备份，完全重新下载           | 低   | 中     | 高     |

选择模式：保存本地备份，重新下载时导入恢复

选择理由： 保存备份虽然会降低安全性但是有前面的加密保护，而重新导人并不困难但对用户下载大文件中断有着极大帮助，重新导人解析或许会消耗时间，但是实际上用户可以通过选择是否维续之前的下载来决定是否导人解析。导人解析本身也可以通过进度的配置文件解决。

### 4.2.4 候选模式与对应ASR

| #    | 模式类型         | 选择的模式                       | 架构驱动                               |
| ---- | ---------------- | -------------------------------- | -------------------------------------- |
| 1    | 资源压缩编码     | RAR压缩                          | 文件上传和下载                         |
| 2    | 资源数据传输协议 | TCP协议                          | 文件上传和下载、用户请求服务           |
| 3    | 资源传输效率     | 镜像服务器加速和离线下载         | 文件上传和下载、用户请求服务           |
| 4    | 中断处理和恢复   | 保存本地备份，重新下载时导入恢复 | 文件上传和下载、断线重连、用户请求服务 |


### 4.2.5 架构视图

图片
