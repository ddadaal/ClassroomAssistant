## 4.1 第2次迭代

### 4.1.1 分解系统组件

选择**上传模块**继续分解。

### 4.1.2 确定架构驱动因素（重要性、难易度从高到低）

| #    | 架构驱动因素                                                 | 重要性 | 难易度 |
| ---- | ------------------------------------------------------------ | ------ | ------ |
| 1    | 场景1：大量用户短时间内进行数据量交换较小的操作（签到、举手、获取或者提交试卷） | 高     | 高     |
| 2    | 场景6：断线重连                                              | 高     | 高     |
| 3    | 场景7：学生数据防止被攻击和篡改                              | 高     | 中     |
| 4    | 场景9：学生使用过程中撤销错误操作                            | 中     | 中     |
| 5    | 场景10：用户请求服务                                         | 中     | 中     |
| 6    | 场景11：用户请求其他用户的信息                               | 中     | 中     |
| 7    | 场景12：文件上传和下载                                       | 高     | 中     |

### 4.1.3 选择满足架构驱动因素的架构模式

#### 4.1.3.1 设计关注点

| 质量属性 | 设计关注点   | 子关注点                           |
| -------- | ------------ | ---------------------------------- |
| 安全性   | 数据源采集   | 数据源压缩编码                     |
| 性能     | 上传数据传输 | 上传数据传输协议、上传数据效率     |
| 可靠性   | 上传数据处理 | 上传数据处理方式、上传数据处理效率 |
| 可用性   | 上传进度     | 上传断点记录、上传数据拆分方式     |

#### 4.1.3.2 候选模式

**数据源压缩编码**

| #    | 模式名称 | 压缩率 | 容错能力 | CPU能力要求 | 压缩时间 |
| ---- | -------- | ------ | -------- | ----------- | -------- |
| 1    | RAR压缩  | 高     | 高       | 高          | 中       |
| 2    | ZIP压缩  | 中     | 低       | 高          | 高       |

选择模式：RAR压缩
选择理由：ZIP占存过大，并且只有英文版，RAR具有官方简体中文且安装包较小，同时RAR压缩率高容错能力高，相比ZIP能支持更多的流行压缩格式。最为关键的是在传输超大型文件过程中RAR支持分卷压缩，降低了上传压力。

**上传数据传输协议**

| #    | 模式名称 | 可靠性 | 实时性 | 连续性 | 完整性 |
| ---- | -------- | ------ | ------ | ------ | ------ |
| 1    | TCP协议  | 强     | 弱     | 一般   | 强     |
| 2    | UDP协议  | 弱     | 强     | 一般   | 弱     |

选择模式：TCP协议
选择理由：TCP协议是面向连接的可靠协议，如果发现分组有丢失现象，会请求进行重传，保证了数据的准确性，保证了数据有序传输。而UDP协议是无连接校验机制的，不会进行数据的校准和分组确认，且传输数据是无序的。我们的系统需要传输的可靠性合完整性，否则可能严重缺失导致稳健运行失败。所以选择TCP协议。

**上传数据效率**

| #    | 模式名称             | 传输效率 | 可用性 | 同时上传数量 |
| ---- | -------------------- | -------- | ------ | ------------ |
| 1    | 提升服务器带宽       | 高       | 中     | 中           |
| 2    | 使用分布式服务器     | 高       | 高     | 多           |
| 3    | 提高客户端的上行带宽 | 中       | 中     | 中           |

选择模式：使用分布式服务器，并根据需求提升个服务器带宽
选择理由：传输效率主要由服务器总带宽和客户端的上行贷款决定，使用分布式服务器不仅可以提升总带宽，而且有更高的可用性合容错性。而且分布式可以在发现相同资源的情况下提高上传的并发量。

**上传数据处理方式**

| #    | 模式名称                                 | 性能要求 | 成本 | 安全性 | 处理效率 |
| ---- | ---------------------------------------- | -------- | ---- | ------ | -------- |
| 1    | 直接存储                                 | 低       | 低   | 低     | 高       |
| 2    | 把文件解压扫描，检查是否有病毒后存储     | 高       | 高   | 高     | 低       |
| 3    | 只解压一小部分文件，检查是否有病毒后存储 | 中       | 中   | 中     | 中       |

选择模式：模式3
选择理由：直接存储安全性太低，全部解压扫描效率太低，所以选择解压部分扫描抽查。

**上传数据处理效率**

| #    | 模式名称               | 处理速率 | 可伸缩性 | 可用性 |
| ---- | ---------------------- | -------- | -------- | ------ |
| 1    | 使用RAD5存储上传的数据 | 中       | 中       | 高     |
| 2    | 边解压边分析数据       | 高       | 高       | 低     |
| 3    | 解压完成再分析数据     | 中       | 中       | 低     |

选择模式：模式1and模式2
选择理由：系统突然崩溃时可使用另外一个校验信息，恢复之前上传的数据，提高了可用性，使用边解压边分析有效提高了数据的处理效率。

**上传断点记录**

| #    | 模式名称             | 上传速率 | 可用性 | 可同时上传数量 |
| ---- | -------------------- | -------- | ------ | -------------- |
| 1    | 自定义断点交互协议   | 中       | 高     | 高             |
| 2    | 使用http断点下载协议 | 高       | 高     | 中             |

选择模式：模式1
选择理由：自定义断点交互协议可以让游览器记住最近一次成功传输的位置，也可以把上传的断点放在服务器端。

**上传数据拆分方式**

| #    | 模式名称          | 处理速率 | 可伸缩性 | 可用性 |
| ---- | ----------------- | -------- | -------- | ------ |
| 1    | 定义拆分单元为1M  | 中       | 高       | 高     |
| 2    | 定义拆分单元为10M | 高       | 中       | 中     |

选择模式：模式1
选择理由：传输单元为1M，没有占用太多的传输通道，可以增加更多的并发，使得统一用户在同一时间，上传更多的文件。

### 4.1.4 候选模式与对应ASR

| #    | 模式类型         | 选择的模式                                   | 架构驱动 |
| ---- | ---------------- | -------------------------------------------- | -------- |
| 1    | 数据源压缩编码   | RAR压缩                                      |          |
| 2    | 上传数据传输协议 | TCP协议                                      |          |
| 3    | 上传数据效率     | 使用分布式服务器，并根据需求提升个服务器带宽 |          |
| 4    | 上传数据处理方式 | 只解压一小部分文件，检查是否有病毒后存储     |          |
| 5    | 上传数据处理效率 | 使用RAD5存储上传的数据、边解压边分析数据     |          |
| 6    | 上传断点记录     | 自定义断点交互协议                           |          |
| 7    | 上传数据拆分方式 | 定义拆分单元为1M                             |          |

### 4.1.5 架构视图

图片

## 4.3 第3次迭代

### 4.3.1 分解系统组件

选择**推送模块**继续分解。

### 4.3.2 确定架构驱动因素 

| #    | 架构驱动因素                        | 重要性 | 难易度 |
| ---- | ----------------------------------- | ------ | ------ |
| 1    | 场景4：推送信息需要快速有效到达用户 | 高     | 高     |
| 2    | 场景3：由于各种原因导致的系统出错   | 中     | 中     |

### 4.3.3 选择满足架构驱动因素的架构模式

#### 4.3.3.1 设计关注点

| 质量属性 | 设计关注点       | 子关注点                             |
| -------- | ---------------- | ------------------------------------ |
| 性能     | 推送信息到达用户 | 用户推送效率、离线用户获得推送方式   |
| 可靠性   | 确保信息有效到达 | 确保信息到达用户                     |
| 安全性   |                  | 用户推送信息不错位，对其他用户不可见 |

#### 4.3.3.2 候选模式

**用户推送效率**

| #    | 模式名称               | 开发难度 | 加速效果 | 安全性 |
| ---- | ---------------------- | -------- | -------- | ------ |
| 1    | 优先处理推送信息请求   | 中       | 好       | 高     |
| 2    | 按顺序处理信息发送请求 | 中       | 中       | 中     |

选择模式：**优先处理推送信息请求**

选择原因：通过优先处理推送信息请求可以保证推送模块的优先级，因为推送优先级较高能保证推送消息快速到达用户，提高效率

**离线用户获得推送方式**

| #    | 模式名称                                               | 开发难度 | 加速效果 | 安全性 | 未送达概率 |
| ---- | ------------------------------------------------------ | -------- | -------- | ------ | ---------- |
| 1    | 离线用户上传后再由服务器发送推送                       | 中       | 中       | 高     | 高         |
| 2    | 服务器发送推送数据到本机，离线用户上线后从本地读取推送 | 中       | 中       | 中     | 中         |

选择模式：**离线用户上传后再由服务器发送推送**

选择原因：提前发送至本机，安全性无法保障且容易被盗取。

**确保信息到达用户**

| #    | 模式名称  | 开发难度 | 性能影响 | 能否保证到达 |
| ---- | --------- | -------- | -------- | ------------ |
| 1    | 回执+重发 | 中       | 中       | 能           |
| 2    | 多次发送  | 低       | 中       | 不能         |

选择模式：**回执+重发**

选择原因：设备收到信息发送回执，若原设备一段时间未收到回执就重发。这样可以在保证信息到达的情况下减少网络压力。

**用户推送信息不错位，对其他用户不可见**

| #    | 模式名称             | 开发难度 | 性能影响 | 安全性 |
| ---- | -------------------- | -------- | -------- | ------ |
| 1    | 广播式发送           | 低       | 低       | 低     |
| 2    | 定点指定用户发送信息 | 中       | 低       | 高     |

选择模式：**定点指定用户发送信息**

选择原因：广播式发送缺乏安全性，容易泄露推送内容

### 4.3.4 候选模式与对应ASR

| #    | 模式类型                             | 选择的模式                       | 架构驱动                             |
| ---- | ------------------------------------ | -------------------------------- | ------------------------------------ |
| 1    | 用户推送效率                         | 优先处理推送信息请求             | 场景4，功能需求：信息推送            |
| 2    | 离线用户获得推送方式                 | 离线用户上传后再由服务器发送推送 | 场景4，功能需求：信息推送，设计约束1 |
| 3    | 确保信息到达用户                     | 回执+重发                        | 场景4，功能需求：信息推送，场景3     |
| 4    | 用户推送信息不错位，对其他用户不可见 | 定点指定用户发送信息             | 设计约束1                            |

### 4.3.5 架构视图

模块视图

## 4.2 第4次迭代

### 4.2.1 分解系统组件

选择**权限管理模块**继续分解。

### 4.2.2 确定架构驱动因素

| #    | 架构驱动因素                              | 重要性 | 难易度 |
| ---- | ----------------------------------------- | ------ | ------ |
| 1    | 设计约束1：用户的数据不得被泄露和非法修改 | 高     | 高     |
| 2    | 场景13：用户执行未授权的操作              | 高     | 高     |
| 3    | 场景7：学生数据防止被攻击和篡改           | 高     | 高     |
| 4    | 场景10：用户请求服务                      | 中     | 高     |
| 5    | 场景2：用户正常操作                       | 中     | 中     |

### 4.2.3 选择满足架构驱动因素的架构模式

#### 4.2.3.1 设计关注点

| 质量属性 | 设计关注点   | 子关注点         |
| -------- | ------------ | ---------------- |
| 安全性   | 数据安全     | 防止非法访问     |
|          |              | 防止非法数据     |
| 可用性   | 高可用时间   | 从攻击中恢复     |
| 性能     | 权限检查速度 | 提高权限检查速度 |

### 4.2.3.2 候选模式

**防止非法访问**

| #    | 模式名称                     | 开发难度 | 性能影响 | 安全性 |
| ---- | ---------------------------- | -------- | -------- | ------ |
| 1    | 对每个请求单独鉴权           | 中       | 中       | 高     |
| 2    | 对每个请求维护可访问资源列表 | 高       | 低       | 高     |
| 3    | 维持可信地址列表             | 低       | 低       | 低     |
| 4    | 维持黑名单                   | 低       | 低       | 低     |

选择模式：**对每个请求单独鉴权**

选择理由：对每个请求都进行鉴权操作能够保证安全性。

**防止非法数据**

| #    | 模式名称     | 开发难度 | 性能影响 | 安全性 |
| ---- | ------------ | -------- | -------- | ------ |
| 1    | 输入数据检验 | 中       | 中       | 高     |

选择模式：**输入数据检验**

选择理由：在提交给后续服务之前检验数据能够确保数据的合法性。

**从攻击中恢复**

| #    | 模式名称     | 开发难度 | 恢复速度 | 用户体验     |
| ---- | ------------ | -------- | -------- | ------------ |
| 1    | 黑名单       | 低       | 高       | 对用户透明   |
| 2    | 重新建立网络 | 低       | 中       | 需要用户操作 |
| 3    | 冗余         | 高       | 高       | 对用户透明   |

选择模式：**黑名单**、**重新建立网络**

选择理由：由于节点硬件规模限制，无法采用冗余配置鉴权模块的方式加快恢复速度。采用黑名单可以快速屏蔽小闺蜜的攻击源，恢复系统运行；若攻击规模大，可采用重新建立网络（自动或者手动）的方式恢复系统功能。

**提高权限检查速度**

| #    | 模式名称     | 开发难度 | 性能         |
| ---- | ------------ | -------- | ------------ |
| 1    | 请求队列     | 中       | 中           |
| 2    | 多线程并行   | 中       | 高           |
| 3    | 提高硬件性能 | 低       | 依赖硬件性能 |

选择模式：**请求队列**、**多线程并行**

选择理由：由于需要在尽可能多的硬件上运行，所以不能把系统性能的提高依赖于硬件性能的提高。多线程能够提高权限检查的速度；使用请求队列能够平滑系统性能，提高效率。

### 4.2.4 候选模式与对应ASR

| #    | 模式类型         | 选择的模式           | 架构驱动                 |
| ---- | ---------------- | -------------------- | ------------------------ |
| 1    | 防止非法访问     | 对每个请求单独鉴权   | 设计约束1，场景7，场景13 |
| 2    | 防止非法数据     | 输入数据检验         | 设计约束1，场景7，场景13 |
| 3    | 从攻击中恢复     | 黑名单、重新建立网络 | 场景2，场景10，设计约束2 |
| 4    | 提高权限检查速度 | 请求队列、多线程并行 | 场景2，场景10，设计约束2 |

### 3.2.5 架构视图

模块视图

